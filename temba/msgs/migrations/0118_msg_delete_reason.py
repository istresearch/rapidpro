# -*- coding: utf-8 -*-
# Generated by Django 1.11.6 on 2018-05-17 16:07
from __future__ import unicode_literals

from django.db import migrations, models

SQL_update_credits = """
----------------------------------------------------------------------------------
-- Updates our topup credits for the topup being assigned to the Msg
----------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION temba_update_topupcredits() RETURNS TRIGGER AS $$
BEGIN
  -- Msg is being created
  IF TG_OP = 'INSERT' THEN
    -- If we have a topup, increment our # of used credits
    IF NEW.topup_id IS NOT NULL THEN
      PERFORM temba_insert_topupcredits(NEW.topup_id, 1);
    END IF;

  -- Msg is being updated
  ELSIF TG_OP = 'UPDATE' THEN
    -- If the topup has changed
    IF NEW.topup_id IS DISTINCT FROM OLD.topup_id THEN
      -- If our old topup wasn't null then decrement our used credits on it
      IF OLD.topup_id IS NOT NULL THEN
        PERFORM temba_insert_topupcredits(OLD.topup_id, -1);
      END IF;

      -- if our new topup isn't null, then increment our used credits on it
      IF NEW.topup_id IS NOT NULL THEN
        PERFORM temba_insert_topupcredits(NEW.topup_id, 1);
      END IF;
    END IF;

  -- Msg is being deleted
  ELSIF TG_OP = 'DELETE' THEN
    -- Remove a used credit if this Msg had one assigned and it isn't being purged
    IF OLD.topup_id IS NOT NULL AND (OLD.delete_reason IS NULL) THEN
      PERFORM temba_insert_topupcredits(OLD.topup_id, -1);
    END IF;
  END IF;

  RETURN NULL;
END;
$$ LANGUAGE plpgsql;
"""


class Migration(migrations.Migration):

    dependencies = [
        ('msgs', '0117_msg_uuid_index'),
    ]

    operations = [
        migrations.AddField(
            model_name='msg',
            name='delete_reason',
            field=models.CharField(choices=[(('A', 'Archive delete'), ('P', 'Purge delete'))], help_text='How the message is being deleted', max_length=1, null=True),
        ),
        migrations.RunSQL(SQL_update_credits, '')

    ]
