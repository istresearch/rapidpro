# Generated by Django 3.2.8 on 2021-11-01 11:21

from django.db import migrations


def cleanup_scheduled_broadcast(apps, schema_editor):  # pragma: no cover
    Broadcast = apps.get_model("msgs", "Broadcast")
    num_contacts, num_groups = 0, 0

    for bcast in Broadcast.objects.exclude(schedule=None):
        for c in bcast.contacts.filter(is_active=False):
            bcast.contacts.remove(c)
            num_contacts += 1
        for g in bcast.groups.filter(is_active=False):
            bcast.groups.remove(g)
            num_groups += 1

    if num_contacts or num_groups:
        print(f"Removed {num_contacts} deleted contacts and {num_groups} deleted groups from scheduled broadcasts")


def reverse(apps, schema_editor):  # pragma: no cover
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("msgs", "0157_auto_20211028_1300"),
    ]

    operations = [migrations.RunPython(cleanup_scheduled_broadcast, reverse)]
