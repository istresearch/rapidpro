# Generated by Django 2.0.9 on 2018-11-12 11:26
from datetime import timedelta

from django.db import migrations
from django.utils import timezone


def interrupt_old_calls(apps, schema_editor):
    ChannelSession = apps.get_model("channels", "ChannelSession")
    FlowSession = apps.get_model("flows", "FlowSession")

    just_about_now = timezone.now()

    DONE = ("D", "B", "F", "N", "C", "X")

    old_active_ivr_calls = ChannelSession.objects.exclude(status__in=DONE).filter(
        created_on__lt=just_about_now - timedelta(days=7), session_type="F"
    )

    print(f"Interrupting {len(old_active_ivr_calls)} IVR calls that are still active and should not be")

    # interrupt ChannelSessions
    old_active_ivr_calls.update(status="X", ended_on=just_about_now)

    # interrupt related flow sessions
    old_flow_sessions = FlowSession.objects.filter(connection_id__in=old_active_ivr_calls)
    old_flow_sessions.update(status="I", ended_on=just_about_now)


class Migration(migrations.Migration):

    dependencies = [("channels", "0104_auto_20181024_0959"), ("flows", "0178_auto_20180926_1714")]

    operations = [migrations.RunPython(interrupt_old_calls)]
