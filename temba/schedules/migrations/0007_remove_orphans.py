# Generated by Django 2.1.8 on 2019-06-13 15:47

from django.db import migrations


def remove_orphans(apps, schema_editor):
    Broadcast = apps.get_model("msgs", "Broadcast")
    Trigger = apps.get_model("triggers", "Trigger")
    Schedule = apps.get_model("schedules", "Schedule")

    used_by_triggers = Trigger.objects.exclude(schedule=None).values_list("schedule_id", flat=True)
    used_by_broadcasts = Broadcast.objects.exclude(schedule=None).values_list("schedule_id", flat=True)
    used = list(used_by_triggers) + list(used_by_broadcasts)

    _, num_deleted = Schedule.objects.exclude(id__in=used).delete()
    if num_deleted:
        print(f"Deleted {num_deleted} orphaned schedules")


def reverse(apps, schema_editor):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("schedules", "0006_initial"),
        ("triggers", "0014_remove_follows"),
        ("msgs", "0131_auto_20190422_2045"),
    ]

    operations = [migrations.RunPython(remove_orphans, reverse)]
